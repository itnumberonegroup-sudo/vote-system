<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>โหวตร้านค้า Numberone Market</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; background-color: #f8f9fa; }
        #voteForm { background: white; max-width: 400px; margin: auto; padding: 25px; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        h2 { color: #28a745; margin-bottom: 25px; }
        .rating { margin: 15px 0; display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 10px; border-radius: 10px; border: 1px solid #eee; }
        input[type="number"] { width: 60px; height: 35px; text-align: center; border-radius: 8px; border: 1px solid #ddd; font-size: 18px; font-weight: bold; color: #28a745; }
        button { background: #28a745; color: white; border: none; padding: 15px; border-radius: 30px; cursor: pointer; width: 100%; font-size: 18px; font-weight: bold; margin-top: 20px; }
        button:active { transform: scale(0.98); background: #218838; }
    </style>
</head>
<body>
    <div id="voteForm">
        <h2>โหวตร้านค้า: <span id="shopIdText">...</span></h2>
        <div class="rating"><span>ความสะอาด:</span> <input type="number" id="clean" min="1" max="5" value="5"></div>
        <div class="rating"><span>รสชาติอร่อย:</span> <input type="number" id="taste" min="1" max="5" value="5"></div>
        <div class="rating"><span>รอไม่นาน:</span> <input type="number" id="wait" min="1" max="5" value="5"></div>
        <div class="rating"><span>คุณภาพ:</span> <input type="number" id="quality" min="1" max="5" value="5"></div>
        <button onclick="submitVote()">ส่งคะแนนโหวต</button>
    </div>

    <script>
        // ใช้ค่าจริงจากภาพที่คุณส่งมา
        const LIFF_ID = '2009063345-QrUBULyk'; 
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfcybyr08i6xVOBQDAnuAfAGLsg9DpgS7WjQ08YshoCX2b6qCoyMT5QXVryUgB-5CR4j4WUcQ/exec';

        async function main() {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) {
                liff.login();
            } else {
                const urlParams = new URLSearchParams(window.location.search);
                const shopId = urlParams.get('shop_id');
                document.getElementById('shopIdText').innerText = shopId || 'ไม่ได้ระบุร้าน';
            }
        }

        async function submitVote() {
            try {
                const profile = await liff.getProfile();
                const urlParams = new URLSearchParams(window.location.search);
                const shopId = urlParams.get('shop_id');

                if (!shopId) {
                    alert('กรุณาสแกน QR Code ของร้านค้าเพื่อโหวต');
                    return;
                }

                const params = new URLSearchParams({
                    shopId: shopId,
                    userId: profile.userId,
                    displayName: profile.displayName,
                    clean: document.getElementById('clean').value,
                    taste: document.getElementById('taste').value,
                    wait: document.getElementById('wait').value,
                    quality: document.getElementById('quality').value
                });

                const res = await fetch(`${WEB_APP_URL}?${params.toString()}`, { method: 'POST' });
                const text = await res.text();

                if (text === "DUPLICATE") {
                    alert("คุณเคยโหวตร้านนี้ไปแล้ว!");
                } else {
                    alert("โหวตสำเร็จ! ขอบคุณที่ร่วมสนุกครับ");
                    liff.closeWindow();
                }
            } catch (e) {
                alert('เกิดข้อผิดพลาด โปรดลองใหม่อีกครั้ง');
            }
        }
        main();
    </script>
</body>
</html>
