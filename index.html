<!DOCTYPE html>
<html lang="th">
<head>
    </head>
<body>

    <div id="loading">
        <div class="spinner"></div>
        <p id="txt-loading" style="margin-top: 15px; font-weight: 600;">กำลังบันทึกคะแนน...</p>
    </div>

    <div id="customAlert" onclick="closeAlert()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="modalIcon" class="modal-icon"></div>
            <h3 id="modalTitle" style="margin: 0;">หัวข้อ</h3>
            <p id="modalMsg" style="color: #64748b; margin-top: 10px;">ข้อความ</p>
            <button class="modal-btn" id="btn-modal-close" onclick="closeAlert()">ตกลง</button>
        </div>
    </div>

    <div class="container">
        <div id="voteForm">
            <div id="alreadyVotedMsg">วันนี้คุณโหวตร้านค้านี้ไปแล้ว</div>
            
            <div class="shop-info">
                <div id="txt-selected-shop" style="font-size: 13px; color: #94a3b8; font-weight: 400;">ร้านค้าที่ท่านเลือก</div>
                <h2 id="shopNameDisplay">กำลังโหลดรายชื่อร้าน...</h2>
            </div>

            <button class="btn-submit" id="btnSubmit" onclick="validateAndSubmit()">ยืนยันการให้คะแนน</button>
        </div>
    </div>

    <script>
        const LIFF_ID = '2009067055-3oHER0LB'; 
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyrDZ4Fmf1zziPkeg4N4MoP08qL2lgZzCLi_EikrklefU4fjInnBZ_W5UztuagwFuEWZg/exec';

        // 2. แก้ไขจุดนี้: เปลี่ยนตัวแปรคงที่ เป็นตัวแปร Global เพื่อรับค่าจาก JavaScript
        let currentShopId = "";
        let currentShopName = "";

        // ... (คงส่วน translations, changeLang, checkVoteHistory ไว้ตามเดิม) ...

        // 3. แก้ไขฟังก์ชัน main: เพิ่มการ Fetch ข้อมูลจาก Apps Script
        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    const urlParams = new URLSearchParams(window.location.search);
                    // รองรับทั้ง shop_id และ shopId
                    currentShopId = urlParams.get('shop_id') || urlParams.get('shopId');

                    if (currentShopId) {
                        try {
                            // ยิง Fetch ไปที่ Apps Script เพื่อขอชื่อร้าน (ใช้ Parameter getShopName)
                            const response = await fetch(`${WEB_APP_URL}?getShopName=${currentShopId}`);
                            currentShopName = await response.text();

                            // นำชื่อร้านมาแสดงผลในหน้าเว็บ
                            document.getElementById('shopNameDisplay').innerText = currentShopName;

                            if (checkVoteHistory(currentShopId)) {
                                document.getElementById('alreadyVotedMsg').style.display = 'block';
                                document.getElementById('btnSubmit').disabled = true;
                                document.getElementById('btnSubmit').innerText = translations[currentLang].alreadyVoted;
                            }
                        } catch (err) {
                            console.error("Fetch Error:", err);
                            document.getElementById('shopNameDisplay').innerText = "เกิดข้อผิดพลาดในการโหลดชื่อร้าน";
                        }
                    } else {
                        document.getElementById('shopNameDisplay').innerText = "ไม่พบรหัสร้านค้า";
                    }
                }
            } catch (error) { console.error("LIFF Error:", error); }
        }

        // ... (คงส่วน showAlert, closeAlert, getSelectedRating, validateAndSubmit ไว้ตามเดิม) ...

        async function submitVote(fullName, phone, rating) {
            const t = translations[currentLang];
            if(!currentShopId) return showAlert(t.alertFail, "Error: No Shop ID", 'error');
            document.getElementById('loading').style.display = 'flex';
            try {
                const profile = await liff.getProfile();
                const params = new URLSearchParams({
                    shopId: currentShopId,
                    shopName: currentShopName,
                    userId: profile.userId,
                    displayName: profile.displayName,
                    fullName: fullName, 
                    phone: phone,
                    quality: rating 
                });
                
                // ส่งข้อมูลไปที่ Apps Script โดยใช้ Method POST
                await fetch(`${WEB_APP_URL}?${params.toString()}`, { method: 'POST' });
                
                saveVoteHistory(currentShopId);
                document.getElementById('loading').style.display = 'none';
                showAlert(t.alertSuccess, t.alertSuccessMsg, 'success');
                setTimeout(() => { liff.closeWindow(); }, 2500);
            } catch (e) {
                document.getElementById('loading').style.display = 'none';
                showAlert(t.alertFail, t.alertFailMsg, 'error');
            }
        }
        main();
    </script>
</body>
</html>
